{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <h3>Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
  <hr>

  <div id="user-info" class="mb-4">
    <p><strong>Ù†Ø§Ù…:</strong> <span id="user-name"></span></p>
    <p><strong>Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†:</strong> <span id="user-phone"></span></p>
  </div>

  <div id="appointments">
    <h5>Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡:</h5>
    <ul id="appointment-list" class="list-group"></ul>
  </div>

  <hr>
  <button class="btn btn-warning mt-3" onclick="window.location.href='{% url 'accounts:changepass_page' %}'">
    ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
  </button>
  
'
  <button class="btn btn-danger mt-3" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const userToken = localStorage.getItem('auth_token');

  if (!userToken) {
    alert('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ø´ÙˆÛŒØ¯');
    window.location.href = "{% url 'accounts:login_page' %}";
  }

  // Ú¯Ø±ÙØªÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
  axios.get('http://localhost:8000/api/user-info/', {
    headers: {
      Authorization: `Bearer ${userToken}`
    }
  }).then(res => {
  
    document.getElementById('user-name').innerText = res.data.name || '---';
    document.getElementById('user-phone').innerText = res.data.phone || '---';
  }).catch(err => {
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±');
    console.error(err);
  });

  // Ú¯Ø±ÙØªÙ† Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
  // Ú¯Ø±ÙØªÙ† Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
axios.get('http://localhost:8000/api/user-appointments/', {
  headers: {
    Authorization: `Bearer ${userToken}`
  }
}).then(res => {
  const list = document.getElementById('appointment-list');
  if (res.data.length === 0) {
    list.innerHTML = '<li class="list-group-item">Ù‡ÛŒÚ† Ù†ÙˆØ¨ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</li>';
  } else {
    res.data.forEach(item => {
      list.innerHTML += `<li class="list-group-item">
        Ø¯Ú©ØªØ±: ${item.doctor_name} | ØªØ§Ø±ÛŒØ®: ${item.date} | Ø³Ø§Ø¹Øª: ${item.time}
      </li>`;
    });
  }
}).catch(err => {
  alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§');
  console.error(err.response ? err.response.data : err);
});

  function changePassword() {
    alert('Ø¯Ø± Ù†Ø³Ø®Ù‡ Ø¨Ø¹Ø¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ğŸ˜‰');
  }

  function logout() {
    if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('refresh_token');
      window.location.href = "{% url 'accounts:hello' %}";
    }
  }
</script>
{% endblock %}
