{% extends 'base.html'%}

{% block content %}

<div class="container my-5" id="doctor-profile" data-doctor-id="{{ doctor.id }}">
    <div class="card shadow-sm">
        <div class="card-header text-center bg-primary text-white">
            <h2>رزرو وقت پزشک</h2>
        </div>
        <div class="card-body">
            <h4 class="text-center mb-4">روزهای قابل رزرو</h4>
            <div id="available-days" class="d-flex flex-wrap justify-content-center gap-2"></div>

            <hr class="my-4">

            <h4 class="text-center mb-4">ساعت‌های خالی</h4>
            <div id="available-times" class="d-flex flex-wrap justify-content-center gap-2"></div>
        </div>
    </div>
</div>

<!-- Modal تایید رزرو -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">تایید رزرو</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>
            <div class="modal-body text-center">
                <p>آیا می‌خواهید وقت <span id="selected-time"></span> را رزرو کنید؟</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">خیر</button>
                <button type="button" class="btn btn-primary" id="confirmReservationBtn">بله، رزرو کن</button>
            </div>
        </div>
    </div>
</div>

<!-- Axios + Bootstrap Bundle (برای Modal کار کنه) -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // تعریف متغیرها در سطح global
    window.selectedTimeId = null;
    window.selectedTime = null;

    document.addEventListener('DOMContentLoaded', function () {
        const doctorProfile = document.getElementById('doctor-profile');
        const doctorId = doctorProfile.getAttribute('data-doctor-id');
        const availableDaysDiv = document.getElementById('available-days');
        const availableTimesDiv = document.getElementById('available-times');

        let selectedDayBtn = null; // برای هایلایت روز

        if (doctorId) {
            showSpinner(availableDaysDiv);
            axios.get(`/api/doctor/${doctorId}/available_day/`)
                .then(function (response) {
                    const days = response.data;
                    availableDaysDiv.innerHTML = '';

                    days.forEach(function (day) {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-outline-primary';
                        btn.textContent = `${day.weekday} (${day.date})`;

                        btn.addEventListener('click', function () {
                            if (selectedDayBtn) {
                                selectedDayBtn.classList.remove('active');
                            }
                            btn.classList.add('active');
                            selectedDayBtn = btn;
                            loadAvailableTimes(day.date);
                        });

                        availableDaysDiv.appendChild(btn);
                    });
                })
                .catch(function (error) {
                    console.error('خطا در گرفتن روزهای قابل رزرو:', error);
                    availableDaysDiv.innerHTML = '<div class="text-danger">خطایی رخ داد</div>';
                });
        }

        // درخواست ورود



        function loadAvailableTimes(date) {
            showSpinner(availableTimesDiv);
            axios.get(`/api/doctor/${doctorId}/available_times/${date}/`)
                .then(function (response) {
                    const times = response.data;
                    availableTimesDiv.innerHTML = '';

                    times.forEach(function (time) {
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-success';
                        btn.textContent = `${time.start_time}`;

                        btn.addEventListener('click', function () {
                            window.selectedTime = time.start_time;
                            window.selectedTimeId = time.id;
                            document.getElementById('selected-time').textContent = window.selectedTime;
                            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                            confirmModal.show();
                        });

                        availableTimesDiv.appendChild(btn);
                    });
                })
                .catch(function (error) {
                    console.error('خطا در گرفتن زمان‌های آزاد:', error);
                    availableTimesDiv.innerHTML = '<div class="text-danger">خطایی رخ داد</div>';
                });
        }

        function showSpinner(container) {
            container.innerHTML = `
                <div class="d-flex justify-content-center w-100 my-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">در حال بارگذاری...</span>
                    </div>
                </div>
            `;
        }

        // تایید نهایی رزرو
        document.getElementById('confirmReservationBtn').addEventListener('click', function () {
            // بررسی مقدار selectedTimeId و selectedTime
            console.log('Selected Time ID:', window.selectedTimeId);
            console.log('Selected Time:', window.selectedTime);

            if (window.selectedTimeId) {
                const token = localStorage.getItem('auth_token');
                console.log('Token:', token); // بررسی اینکه توکن به درستی دریافت می‌شود

                if (!token) {
                    alert('برای رزرو وقت باید وارد حساب کاربری خود شوید.');
                    return;
                }

                axios.post('/api/reserve_time/', {
                    time_slot_id: window.selectedTimeId,
                    doctor_id: doctorId
                }, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                })
                    .then(res => {
                        // موفقیت
                        alert('رزرو با موفقیت انجام شد!');
                        const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
                        confirmModal.hide();
                        loadAvailableTimes(selectedDayBtn.textContent.split('(')[1].replace(')', ''));
                    })
                    .catch(err => {
                        // خطا
                        if (err.response && err.response.status === 401) {
                            alert('برای رزرو وقت باید وارد حساب کاربری خود شوید.');
                        } else {
                            console.error('خطا در رزرو:', err);
                            alert('خطایی در رزرو پیش آمد.');
                        }
                    });
            }
        });

    });
</script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    document.getElementById('loginForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const phone = document.getElementById('loginPhone').value;
        const password = document.getElementById('loginPassword').value;

        axios.post('/api/login/', {
            phone: phone,
            password: password
        })
            .then(function (response) {
                const token = response.data.token;
                localStorage.setItem('auth_token', token);
                alert('ورود موفق بود!');
                window.location.href = '/';  // یا هر مسیری که دوست داری
            })
            .catch(function (error) {
                console.error('خطا در ورود:', error);
                alert('شماره یا رمز اشتباه است');
            });
    });
    axios.post('/api/login/', {
        phone: 'user_phone',  // موبایل
        password: 'user_password'  // پسورد
    })
        .then(function (response) {
            if (response.data.access) {
                localStorage.setItem('auth_token', response.data.access);  // ذخیره توکن در localStorage
                alert('ورود با موفقیت انجام شد!');
            } else {
                alert('خطا در ورود');
            }
        })
        .catch(function (error) {
            console.error('خطا در ورود:', error);
        });

</script>

{% endblock %}